<!doctype html><html lang=en><head><link href="https://mort.io/abridge.css?h=5f1494977bbccc1fddc1" rel=stylesheet><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1" name=viewport><meta content=https://mort.io name=base><meta content=True name=HandheldFriendly><meta content=yes name=mobile-web-app-capable><meta content=yes name=apple-mobile-web-app-capable><meta content=default name=apple-mobile-web-app-status-bar-style><link title="mort’s mythopœia Atom Feed" href=https://mort.io/atom.xml rel=alternate type=application/atom+xml><link title="mort’s mythopœia RSS Feed" href=https://mort.io/rss.xml rel=alternate type=application/rss+xml><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>Tree-sitting Emacs | mort’s mythopœia</title><meta content="mort’s mythopœia" name=copyright><meta content="Getting [`tree-sitter`](https://www.emacswiki.org/emacs/Tree-sitter) going before turning on [`eglot`](https://www.gnu.org/software/emacs/manual/html_node/eglot/Quick-Start.html)" name=description><link href=https://mort.io/blog/treesitting-emacs/ rel=canonical><meta content=https://mort.io/blog/treesitting-emacs/ property=og:url><meta content=https://mort.io/blog/treesitting-emacs/ name=twitter:url><meta content="Getting [`tree-sitter`](https://www.emacswiki.org/emacs/Tree-sitter) going before turning on [`eglot`](https://www.gnu.org/software/emacs/manual/html_node/eglot/Quick-Start.html)" property=og:description><meta content="Getting [`tree-sitter`](https://www.emacswiki.org/emacs/Tree-sitter) going before turning on [`eglot`](https://www.gnu.org/software/emacs/manual/html_node/eglot/Quick-Start.html)" name=twitter:description><meta content="Tree-sitting Emacs | mort’s mythopœia" property=og:title><meta content="Tree-sitting Emacs | mort’s mythopœia" name=twitter:title><meta content=summary name=twitter:card><meta content="mort’s mythopœia" property=og:site_name><meta content=en_US property=og:locale><meta content=website property=og:type><meta content=2025-10-20 property=og:updated_time><noscript><link href=https://mort.io/nojs.css rel=stylesheet></noscript><body><header><nav><div><big><a title="mort’s mythopœia" href=https://mort.io>mort’s mythopœia</a></big></div><div><div><ul><li><a class=s110 href=https://mort.io/research/> research </a><li><a class=s110 href=https://mort.io/students/> students </a><li><a class=s110 href=https://mort.io/teaching/> teaching </a><li><a class=s110 href=https://mort.io/codes/> codes </a><li><a class=s110 href=https://mort.io/me/> me </a></ul></div><div></div></div></nav><div class=desc>with apologies</div><hr></header><main><article><h1><a href=https://mort.io/blog/treesitting-emacs/>Tree-sitting Emacs</a></h1><span class=s95><span class=hpad> ·</span> 3 min read<span class=hpad> ·</span> October 20, 2025<span class=hpad> ·</span> #<a href=https://mort.io/tags/tech/>tech</a> #<a href=https://mort.io/tags/linux/>linux</a> #<a href=https://mort.io/tags/emacs/>emacs</a> #<a href=https://mort.io/tags/nixos/>nixos</a> #<a href=https://mort.io/tags/config/>config</a> </span><nav><div><a href=https://mort.io/blog/sabbatical-diary-w3/>‹ Sabbatical Diary: Week 3</a></div><div><a href=https://mort.io/blog/sabbatical-diary-w2/> Sabbatical Diary: Week 2 ›</a></div></nav><p>First, some background that it took me longer than I would’ve hoped to piece together.<p><a href=https://tree-sitter.github.io/tree-sitter/ rel=external>Tree-sitter</a> is “a parser generator tool and an incremental parsing library”. What does that mean in pratice? It is a thing which, when paired with a grammar, parses your source code and enables syntax highlighting, code folding, and so on. Syntactic manipulations. It comes with a domain specific language (DSL) for writing grammars and so, happily, many languages are already supported. It is also, as of Emacs 29, included out of the box.<p>On the other hand, <a href=https://www.gnu.org/software/emacs/manual/html_node/eglot/Quick-Start.html rel=external>Eglot</a>, also included out of the box since Emacs 29, provides the <a href=https://microsoft.github.io/language-server-protocol/ rel=external>Language Server Protocol (LSP)</a> interaction. This supports semantic rather than syntactic markup: inline hints, invocation of code formatters, and so on. More on that next.<h2 id=nixos-packages><a aria-label="Anchor link for: nixos-packages" class=zola-anchor href=#nixos-packages>NixOS packages</a></h2><p>I am of course also using NixOS, with flakes and Home Manager, so it took a bit of faffing about to get this all working but I think I got there in the end. First, the NixOS runes needed to install relevant Emacs packages:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=nix><span class=giallo-l><span>programs</span><span style=color:#859900>.</span><span>emacs</span><span style=color:#dc322f> =</span><span> {</span></span>
<span class=giallo-l><span style=color:#93a1a1>  enable</span><span style=color:#859900> =</span><span style=color:#b58900> true</span><span>;</span></span>
<span class=giallo-l><span style=color:#93a1a1>  package</span><span style=color:#859900> =</span><span> pkgs</span><span style=color:#859900>.</span><span>emacs-gtk;</span></span>
<span class=giallo-l><span style=color:#93a1a1>  extraPackages</span><span style=color:#859900> =</span></span>
<span class=giallo-l><span>    epkgs:</span><span style=color:#859900> with</span><span> epkgs; ([</span></span>
<span class=giallo-l><span style=color:#586e75;font-style:italic>      # ...</span></span>
<span class=giallo-l><span>      tree-sitter-langs</span></span>
<span class=giallo-l><span>      (treesit-grammars</span><span style=color:#859900>.</span><span>with-grammars (p: [</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-bash</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-dockerfile</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-elisp</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-markdown</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-markdown-inline</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-nix</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-ocaml</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-python</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-rust</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-toml</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-typst</span></span>
<span class=giallo-l><span>        p</span><span style=color:#859900>.</span><span>tree-sitter-yaml</span></span>
<span class=giallo-l><span>      ]))</span></span>
<span class=giallo-l><span>    ]);</span></span>
<span class=giallo-l><span>}</span><span style=color:#dc322f>;</span></span></code></pre><p>You could use the <code>treesit-grammars.with-all-grammars</code> package instead of the final expression that selects specific grammars, but I found that package did not include all the grammars I actually wanted, hence doing it by hand. It is also in principle possible to allow the Emacs <code>treesit-auto</code> package to download and install grammars on demand. Grammars are first sought in <code>treesit-extra-load-path</code> – in my case a gnarly and ever evolving Nix path, currently <code>/nix/store/4p4rfax61q9z6c5wj7ahnb8hjq8pa11g-emacs-packages-deps/lib/</code>. If they are not found there, they are next looked for in <code>${user-emacs-directory}/tree-sitter/</code> with <code>${user-emacs-directory}</code> resolving in my case to <code>~/.emacs.d</code>. <code>treesit-auto</code> places them in the latter location.<p>Additionally, the <code>emacs-lsp-booster</code> package claims to speed things up, so why not:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=nix><span class=giallo-l><span>home</span><span style=color:#859900>.</span><span>packages</span><span style=color:#dc322f> = with</span><span> pkgs</span><span style=color:#dc322f>;</span><span> [ emacs-lsp-booster ]</span><span style=color:#dc322f>;</span></span></code></pre><h2 id=emacs-configuration><a aria-label="Anchor link for: emacs-configuration" class=zola-anchor href=#emacs-configuration>Emacs configuration</a></h2><p>This was a bit fiddly but not too bad in the end. First install packages comprising the tree-sitter grammars, an auto-installer for missing grammars, and enabling code folding via tree-sitter:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> tree-sitter-langs </span><span style=color:#586e75;font-style:italic>;; grammar bundle</span></span>
<span class=giallo-l><span>  :after tree-sitter</span></span>
<span class=giallo-l><span>  :custom (global-tree-sitter-mode </span><span style=color:#b58900>t</span><span>))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> treesit-auto </span><span style=color:#586e75;font-style:italic>;; auto-install missing grammars</span></span>
<span class=giallo-l><span>  :after tree-sitter</span></span>
<span class=giallo-l><span>  :config (global-treesit-auto-mode))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> treesit-fold </span><span style=color:#586e75;font-style:italic>;; enable code folding based on tree-sitter</span></span>
<span class=giallo-l><span>  :vc (:url</span><span style=color:#2aa198> "https://github.com/emacs-tree-sitter/treesit-fold"</span><span>)</span></span>
<span class=giallo-l><span>  :config (treesit-fold-mode)</span></span>
<span class=giallo-l><span>  :bind</span></span>
<span class=giallo-l><span>  ((</span><span style=color:#2aa198>"C-`"</span><span style=color:#268bd2> .</span><span> treesit-fold-toggle)</span></span>
<span class=giallo-l><span>   (</span><span style=color:#2aa198>"C-€"</span><span style=color:#268bd2> .</span><span> treesit-fold-close-all) </span><span style=color:#586e75;font-style:italic>;; I remap S-` to € using `keyd` so can't use C-S-`</span></span>
<span class=giallo-l><span>   (</span><span style=color:#2aa198>"M-C-€"</span><span style=color:#268bd2> .</span><span> treesit-fold-open-all)))</span></span></code></pre><p>Then, configure the <code>-ts-</code> version for each relevant major <code>-mode</code>, e.g., for Dockerfile and Nix:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> dockerfile-ts-mode</span></span>
<span class=giallo-l><span>  :mode</span><span style=color:#2aa198> "</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>Dockerfile</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>'"</span></span>
<span class=giallo-l><span>  :config (add-to-list </span><span style=color:#268bd2>'</span><span>major-mode-remap-alist </span><span style=color:#268bd2>'</span><span>((docker-mode </span><span style=color:#268bd2>.</span><span> docker-ts-mode))))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> nix-ts-mode</span></span>
<span class=giallo-l><span>  :mode</span><span style=color:#2aa198> "</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>.nix</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>'"</span></span>
<span class=giallo-l><span>  :config (add-to-list </span><span style=color:#268bd2>'</span><span>major-mode-remap-alist </span><span style=color:#268bd2>'</span><span>((nix-mode </span><span style=color:#268bd2>.</span><span> nix-ts-mode))))</span></span></code></pre><p>…and so on. The examples above do two things: set the file glob pattern to which the major mode will apply, and remap the “default” major mode <code>LANGUAGE-mode</code> to the new tree-sitter major mode, <code>LANGUAGE-ts-mode</code>.<p><a href=https://microsoft.github.io/language-server-protocol/ rel=external>LSP</a> support via <a href=https://www.gnu.org/software/emacs/manual/html_node/eglot/Quick-Start.html rel=external>Eglot</a> then requires installing any necessary language servers and configuring them. More on that next.<nav><div><a href=https://mort.io/blog/sabbatical-diary-w3/>‹ Sabbatical Diary: Week 3</a></div><div><a href=https://mort.io/blog/sabbatical-diary-w2/> Sabbatical Diary: Week 2 ›</a></div></nav></article></main><footer><hr><div class=c><nav class=tpad><div><a title="mort’s mythopœia Atom Feed" href=https://mort.io/atom.xml target=_blank type=application/atom+xml><i class="svg rss" title="mort’s mythopœia Atom Feed" type=Button></i></a><a title="mort’s mythopœia RSS Feed" href=https://mort.io/rss.xml target=_blank type=application/rss+xml><i class="svg rss" title="mort’s mythopœia RSS Feed" type=Button></i></a><a href=mailto:richard.mortier@cl.cam.ac.uk target=_blank title=Mail><i class="svg mail" title=Mail type=Button></i></a><a href=https://mastodon.me.uk/@mort rel=me target=_blank title=Mastodon><i class="svg mastodon" title=Mastodon type=Button></i></a><a href=https://www.linkedin.com/in/richard-mortier/ target=_blank title=LinkedIn><i class="svg linkedin" title=LinkedIn type=Button></i></a><a href=https://github.com/mor1/ target=_blank title=Github><i class="svg github" title=Github type=Button></i></a><a href=https://hub.docker.com/u/mor1/ target=_blank title=Docker><i class="svg docker" title=Docker type=Button></i></a><a href="https://www.youtube.com/playlist?list=PLkRF0fgqvvMx5Owh1QgilmExGQe58go_u" target=_blank title=YouTube><i class="svg youtube" title=YouTube type=Button></i></a></div></nav><nav class=vpad><a class=rpad href=https://mort.io/sitemap.xml target=_blank> sitemap </a><a class=rpad href=https://mort.io/tags/> tags </a></nav><p class=s90>mort’s mythopœia © 2013—<span id=year>2026</span> Richard Mortier</div></footer><span class=topout> <span class=topleft> </span><a title="Back to Top" class=top href=#><i class="svgs svgh angu"></i></a> </span>