<!doctype html><html lang=en><head><link href="https://mort.io/abridge.css?h=5f1494977bbccc1fddc1" rel=stylesheet><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1" name=viewport><meta content=https://mort.io name=base><meta content=True name=HandheldFriendly><meta content=yes name=mobile-web-app-capable><meta content=yes name=apple-mobile-web-app-capable><meta content=default name=apple-mobile-web-app-status-bar-style><link title="mort’s mythopœia Atom Feed" href=https://mort.io/atom.xml rel=alternate type=application/atom+xml><link title="mort’s mythopœia RSS Feed" href=https://mort.io/rss.xml rel=alternate type=application/rss+xml><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>E(pi)glot-tal start | mort’s mythopœia</title><meta content="mort’s mythopœia" name=copyright><meta content="Swindonians usually use an epiglottal stop, see?" name=description><link href=https://mort.io/blog/emacs-eglot/ rel=canonical><meta content=https://mort.io/blog/emacs-eglot/ property=og:url><meta content=https://mort.io/blog/emacs-eglot/ name=twitter:url><meta content="Swindonians usually use an epiglottal stop, see?" property=og:description><meta content="Swindonians usually use an epiglottal stop, see?" name=twitter:description><meta content="E(pi)glot-tal start | mort’s mythopœia" property=og:title><meta content="E(pi)glot-tal start | mort’s mythopœia" name=twitter:title><meta content=summary name=twitter:card><meta content="mort’s mythopœia" property=og:site_name><meta content=en_US property=og:locale><meta content=website property=og:type><meta content=2025-10-29 property=og:updated_time><noscript><link href=https://mort.io/nojs.css rel=stylesheet></noscript><body><header><nav><div><big><a title="mort’s mythopœia" href=https://mort.io>mort’s mythopœia</a></big></div><div><div><ul><li><a class=s110 href=https://mort.io/research/> research </a><li><a class=s110 href=https://mort.io/students/> students </a><li><a class=s110 href=https://mort.io/teaching/> teaching </a><li><a class=s110 href=https://mort.io/codes/> codes </a><li><a class=s110 href=https://mort.io/me/> me </a></ul></div><div></div></div></nav><div class=desc>with apologies</div><hr></header><main><article><h1><a href=https://mort.io/blog/emacs-eglot/>E(pi)glot-tal start</a></h1><span class=s95><span class=hpad> ·</span> 6 min read<span class=hpad> ·</span> October 29, 2025<span class=hpad> ·</span> #<a href=https://mort.io/tags/tech/>tech</a> #<a href=https://mort.io/tags/linux/>linux</a> #<a href=https://mort.io/tags/emacs/>emacs</a> #<a href=https://mort.io/tags/nixos/>nixos</a> #<a href=https://mort.io/tags/config/>config</a> </span><aside class=updates><ul><li>2025-12-20: Corrected stanzas for <code>toml-ts-mode</code> and <code>bash-ts-mode</code>.</ul></aside><nav><div><a href=https://mort.io/blog/sabbatical-diary-w4/>‹ Sabbatical Diary: Week 4 / Month 1</a></div><div><a href=https://mort.io/blog/sabbatical-diary-w3/> Sabbatical Diary: Week 3 ›</a></div></nav><p>Following on from an earlier post about <a href=/blog/treesitting-emacs/>Tree-sitter</a>, <a href=https://www.gnu.org/software/emacs/manual/html_node/eglot/index.html rel=external>Eglot</a> is the Emacs <a href=https://microsoft.github.io/language-server-protocol/ rel=external>Language Server Protocol (LSP)</a> client. Being also now included in Emacs from v29, it works well with <a href=/blog/treesitting-emacs/>Tree-sitter</a>, integrating servers that can provide rich semantic analysis and tooling for a wide range of languages.<h2 id=basic-eglot-configuration><a aria-label="Anchor link for: basic-eglot-configuration" class=zola-anchor href=#basic-eglot-configuration>Basic Eglot configuration</a></h2><p>I split my Emacs configuration for Eglot across some default configuration plus language specific modes, as far as possible. Default configuration first:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> eglot</span></span>
<span class=giallo-l><span>  :config</span></span>
<span class=giallo-l><span>  (setq-default eglot-workspace-configuration ...) </span><span style=color:#586e75;font-style:italic>;; ...but see below</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  :custom</span></span>
<span class=giallo-l><span>  (eglot-send-changes-idle-time </span><span style=color:#d33682>0.5</span><span>)</span></span>
<span class=giallo-l><span>  (eglot-extend-to-xref </span><span style=color:#b58900>t</span><span>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  :hook</span></span>
<span class=giallo-l><span>  (eglot-managed-mode </span><span style=color:#268bd2>.</span><span> eglot-inlay-hints-mode)</span></span>
<span class=giallo-l><span>  (prog-mode</span></span>
<span class=giallo-l><span style=color:#268bd2>   .</span></span>
<span class=giallo-l><span>   (</span><span style=color:#93a1a1;font-weight:700>lambda</span><span> ()</span></span>
<span class=giallo-l><span>     (</span><span style=color:#93a1a1;font-weight:700>unless</span><span> (</span><span style=color:#268bd2>eq</span><span> major-mode </span><span style=color:#268bd2>'</span><span>emacs-lisp-mode)</span></span>
<span class=giallo-l><span>       (eglot-ensure))))</span></span>
<span class=giallo-l><span>  (before-save</span></span>
<span class=giallo-l><span style=color:#268bd2>   .</span></span>
<span class=giallo-l><span>   (</span><span style=color:#93a1a1;font-weight:700>lambda</span><span> ()</span></span>
<span class=giallo-l><span>     (</span><span style=color:#859900>if</span><span> (eglot-managed-p)</span></span>
<span class=giallo-l><span>         (eglot-format))))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  :bind</span></span>
<span class=giallo-l><span>  (:map</span></span>
<span class=giallo-l><span>   eglot-mode-map</span></span>
<span class=giallo-l><span>   (</span><span style=color:#2aa198>"C-c c a"</span><span style=color:#268bd2> .</span><span> eglot-code-actions)</span></span>
<span class=giallo-l><span>   (</span><span style=color:#2aa198>"C-c c o"</span><span style=color:#268bd2> .</span><span> eglot-code-actions-organize-imports)</span></span>
<span class=giallo-l><span>   (</span><span style=color:#2aa198>"C-c c r"</span><span style=color:#268bd2> .</span><span> eglot-rename)</span></span>
<span class=giallo-l><span>   (</span><span style=color:#2aa198>"C-c c f"</span><span style=color:#268bd2> .</span><span> eglot-format)))</span></span></code></pre><p>This sets up Eglot to run for all programming modes (<code>prog-mode</code>) except <code>emacs-lisp-mode</code> because there is no LSP for that, it being rather integral to Emacs itself! I will also configure it for a few non-programming modes in other relevant <code>use-package</code> stanzas. Finally, I configure calling Eglot’s (language specific) format function before saving, and a few useful key-bindings. See below for <a href=https://mort.io/blog/emacs-eglot/#workspace-configuration>workspace configuration</a>.<p>I also add <a href=https://github.com/jdtsmith/eglot-booster rel=external><code>eglot-booster</code></a> as that enables Eglot to use the <code>emacs-lsp-booster</code> wrapper which should speed up LSP server interactions:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> eglot-booster</span></span>
<span class=giallo-l><span>  :vc (:url</span><span style=color:#2aa198> "https://github.com/jdtsmith/eglot-booster"</span><span>)</span></span>
<span class=giallo-l><span>  :after eglot</span></span>
<span class=giallo-l><span>  :config (eglot-booster-mode))</span></span></code></pre><h2 id=configuring-for-specific-languages><a aria-label="Anchor link for: configuring-for-specific-languages" class=zola-anchor href=#configuring-for-specific-languages>Configuring for specific languages</a></h2><h3 id=simple-toml-and-bash><a aria-label="Anchor link for: simple-toml-and-bash" class=zola-anchor href=#simple-toml-and-bash>Simple: TOML and Bash</a></h3><p>Configuring for a particular language is then relatively straightforward for some. For example, for TOML I use <a href=https://tombi-toml.github.io/tombi/ rel=external>Tombi</a> in the tree-sitter TOML mode, <code>toml-ts-mode</code>:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> toml-ts-mode</span></span>
<span class=giallo-l><span>  :mode</span><span style=color:#2aa198> "</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>.toml</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>'"</span></span>
<span class=giallo-l><span>  :hook eglot-ensure </span><span style=color:#586e75;font-style:italic>;; not a `prog-mode` so not set by the global default</span></span>
<span class=giallo-l><span>  :init (add-to-list </span><span style=color:#268bd2>'</span><span>major-mode-remap-alist </span><span style=color:#268bd2>'</span><span>((toml-mode </span><span style=color:#268bd2>.</span><span> toml-ts-mode)))</span></span>
<span class=giallo-l><span>  :config (add-to-list </span><span style=color:#268bd2>'</span><span>eglot-server-programs </span><span style=color:#268bd2>'</span><span>(toml-ts-mode </span><span style=color:#268bd2>.</span><span> (</span><span style=color:#2aa198>"tombi" "lsp"</span><span>))))</span></span></code></pre><p>This replaces the default <code>toml-mode</code> with the tree-sitter <code>toml-ts-mode</code>, and ensures the Tombi TOML language server is running when in that mode.<p>Bash is similarly straightforward using the <a href=https://github.com/bash-lsp/bash-language-server rel=external><code>bash-language-server</code></a>:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> bash-ts-mode</span></span>
<span class=giallo-l><span>  :ensure</span><span style=color:#b58900> nil</span><span style=color:#586e75;font-style:italic> ;; as there's no package to install</span></span>
<span class=giallo-l><span>  :custom</span></span>
<span class=giallo-l><span>  (tab-width </span><span style=color:#d33682>2</span><span>)</span></span>
<span class=giallo-l><span>  (sh-basic-offset </span><span style=color:#d33682>2</span><span>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  :init</span></span>
<span class=giallo-l><span>  (add-to-list </span><span style=color:#268bd2>'</span><span>major-mode-remap-alist </span><span style=color:#268bd2>'</span><span>(bash-mode </span><span style=color:#268bd2>.</span><span> bash-ts-mode))</span></span>
<span class=giallo-l><span>  (add-to-list </span><span style=color:#268bd2>'</span><span>major-mode-remap-alist </span><span style=color:#268bd2>'</span><span>(sh-mode </span><span style=color:#268bd2>.</span><span> bash-ts-mode)))</span></span></code></pre><p>This stops <code>use-package</code> complaining that there is no <code>bash-ts-mode</code> package, sets tabs to be just two spaces for both <code>shfmt</code> and <code>indent-for-tab-command</code> (YMMV), and remaps the default <code>bash-</code>/<code>sh-</code> modes to use this <code>bash-ts-mode</code>. I don’t need to set <code>eglot-server-programs</code> in this case because the pre-configured default is set to use <code>bash-language-server</code> appropriately.<p>I did try using the <code>:initializationOptions</code> option when starting the <code>bash-language-server</code> as follows:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>:config</span></span>
<span class=giallo-l><span>(add-to-list</span></span>
<span class=giallo-l><span style=color:#268bd2> '</span><span>eglot-server-programs</span></span>
<span class=giallo-l><span style=color:#268bd2> '</span><span>(bash-ts-mode</span></span>
<span class=giallo-l><span style=color:#268bd2>   .</span></span>
<span class=giallo-l><span>   (</span><span style=color:#2aa198>"bash-language-server" "start"</span></span>
<span class=giallo-l><span>    :initializationOptions</span></span>
<span class=giallo-l><span>    (:backgroundAnalysisMaxFiles</span></span>
<span class=giallo-l><span style=color:#d33682>     0</span><span style=color:#586e75;font-style:italic> ;; turn off background analysis of directory tree</span></span>
<span class=giallo-l><span>     :shfmt (:binaryNextLine</span><span style=color:#b58900> t</span><span> :caseIndent</span><span style=color:#b58900> t</span><span> :simplifyCode</span><span style=color:#b58900> t</span><span> :spaceRedirects</span><span style=color:#b58900> t</span><span>)))))</span></span></code></pre><p>…but unfortunately it seems that <code>bash-language-server</code> doesn’t respect this option, so it needs to be set in <code>eglot-workspace-configuration</code> (see below).<h3 id=slightly-more-complex-nix><a aria-label="Anchor link for: slightly-more-complex-nix" class=zola-anchor href=#slightly-more-complex-nix>Slightly more complex: Nix</a></h3><p>Nix is a little more complex as I would like to use the (non-preconfigured default) <a href=https://github.com/nix-community/nixd rel=external><code>nixd</code></a> LSP server and configure it to use <a href=https://github.com/NixOS/nixfmt rel=external><code>nixfmt</code></a> for formatting. In this case I do so by passing in <code>:initializationOptions</code>:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> nix-ts-mode</span></span>
<span class=giallo-l><span>  :mode</span><span style=color:#2aa198> "</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>.nix</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>'"</span></span>
<span class=giallo-l><span>  :config</span></span>
<span class=giallo-l><span>  (add-to-list</span></span>
<span class=giallo-l><span style=color:#268bd2>   '</span><span>eglot-server-programs</span></span>
<span class=giallo-l><span style=color:#268bd2>   '</span><span>((nix-mode nix-ts-mode)</span></span>
<span class=giallo-l><span style=color:#268bd2>     .</span></span>
<span class=giallo-l><span>     (</span><span style=color:#2aa198>"nixd"</span></span>
<span class=giallo-l><span style=color:#2aa198>      "--semantic-tokens"</span></span>
<span class=giallo-l><span style=color:#2aa198>      "--inlay-hints"</span></span>
<span class=giallo-l><span>      :initializationOptions (:nixd (:formatting.command</span><span style=color:#2aa198> "nixfmt"</span><span>))))))</span></span></code></pre><p>As with <code>bash-ts-mode</code>, this remaps the default <code>nix-mode</code> to <code>nix-ts-mode</code>, but then goes on to specify the language server command line to run, and an initialisation option to use <code>nixfmt</code> for formatting.<h3 id=more-complex-python-latex-typst><a aria-label="Anchor link for: more-complex-python-latex-typst" class=zola-anchor href=#more-complex-python-latex-typst>More complex: Python, LaTeX, Typst</a></h3><p>Python is more complex as I use <code>ruff</code> for formatting but it doesn’t support much beyond that at present so I use <a href=https://docs.basedpyright.com/latest/ rel=external>basedpyright</a> for type hinting and the rest. After installing the NixOS <code>basedpyright</code>, <code>ruff</code>, and <code>python313Packages.python-lsp-server</code> packages, this results in:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> python-ts-mode</span></span>
<span class=giallo-l><span>  :ensure</span><span style=color:#b58900> nil</span></span>
<span class=giallo-l><span>  :after (eglot reformatter)</span></span>
<span class=giallo-l><span>  :preface</span></span>
<span class=giallo-l><span style=color:#586e75;font-style:italic>  ;; per https://ddavis.io/blog/python-emacs-4/</span></span>
<span class=giallo-l><span>  (reformatter-define</span></span>
<span class=giallo-l><span>   dd/ruff-format</span></span>
<span class=giallo-l><span>   :program</span><span style=color:#2aa198> "ruff"</span><span style=color:#586e75;font-style:italic> ;; "uvx" with "ruff" as an arg doesn't work because dynamic linking on NixOS</span></span>
<span class=giallo-l><span>   :args</span><span style=color:#268bd2> `</span><span>(</span><span style=color:#2aa198>"format" "--stdin-filename"</span><span style=color:#268bd2> ,</span><span>buffer-file-name </span><span style=color:#2aa198>"-"</span><span>))</span></span>
<span class=giallo-l><span>  (reformatter-define</span></span>
<span class=giallo-l><span>   dd/ruff-sort</span></span>
<span class=giallo-l><span>   :program</span><span style=color:#2aa198> "ruff"</span></span>
<span class=giallo-l><span>   :args</span></span>
<span class=giallo-l><span style=color:#268bd2>   `</span><span>(</span><span style=color:#2aa198>"check" "--select" "I" "--fix" "--stdin-filename"</span><span style=color:#268bd2> ,</span><span>buffer-file-name </span><span style=color:#2aa198>"-"</span><span>))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  :hook</span></span>
<span class=giallo-l><span>  ((python-base-mode </span><span style=color:#268bd2>.</span><span> dd/ruff-format-on-save-mode)</span></span>
<span class=giallo-l><span>   (python-base-mode </span><span style=color:#268bd2>.</span><span> dd/ruff-sort-on-save-mode))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  :init</span></span>
<span class=giallo-l><span>  (add-to-list </span><span style=color:#268bd2>'</span><span>major-mode-remap-alist </span><span style=color:#268bd2>'</span><span>(python-mode </span><span style=color:#268bd2>.</span><span> python-ts-mode))</span></span>
<span class=giallo-l><span>  (add-to-list</span></span>
<span class=giallo-l><span style=color:#268bd2>   '</span><span>eglot-server-programs</span></span>
<span class=giallo-l><span style=color:#268bd2>   '</span><span>((python-mode python-ts-mode) </span><span style=color:#268bd2>.</span><span> (</span><span style=color:#2aa198>"basedpyright-langserver" "--stdio"</span><span>))))</span></span></code></pre><p>This essentially does three things: defines two <code>reformatter</code> functions using <a href=https://docs.astral.sh/ruff/ rel=external><code>ruff</code></a>, one to reformat the code and the other to sort imports; and sets <a href=https://docs.basedpyright.com/latest/ rel=external><code>basedpyright</code></a> as the language server to use, by shadowing the default entries for Python in <code>eglot-server-programs</code>.<p>I also turn on <a href=https://github.com/z80dev/uv-mode rel=external><code>uv-mode</code></a> as I use <a href=https://github.com/astral-sh/uv rel=external><code>uv</code></a> for all Python package management:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> uv-mode</span></span>
<span class=giallo-l><span>  :after (eglot python-base-mode)</span></span>
<span class=giallo-l><span>  :hook (python-base-mode </span><span style=color:#268bd2>.</span><span> uv-mode-auto-activate-hook))</span></span></code></pre><p>Finally, for the purposes of this blog post, for document processing I use LaTeX historically and am now trying to use typst. LaTeX first using the <a href=https://github.com/emacs-languagetool/eglot-ltex-plus rel=external><code>eglot-ltex-plus</code></a> server:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> eglot-ltex-plus</span></span>
<span class=giallo-l><span>  :vc (:url</span><span style=color:#2aa198> "https://github.com/emacs-languagetool/eglot-ltex-plus"</span><span> :rev :newest)</span></span>
<span class=giallo-l><span>  :custom</span></span>
<span class=giallo-l><span>  (eglot-ltex-plus-server-path</span></span>
<span class=giallo-l><span style=color:#2aa198>   "/nix/store/3ihx8s39rl2d5by5wabcg3i4rcm3kns3-ltex-ls-plus-18.6.0/"</span><span>)</span></span>
<span class=giallo-l><span>  (eglot-ltex-plus-communication-channel </span><span style=color:#268bd2>'</span><span>stdio))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> latex</span></span>
<span class=giallo-l><span>  :ensure auctex</span></span>
<span class=giallo-l><span>  :mode</span></span>
<span class=giallo-l><span>  ((</span><span style=color:#2aa198>"</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>.tex</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>'"</span><span style=color:#268bd2> .</span><span> latex-mode)</span></span>
<span class=giallo-l><span>   (</span><span style=color:#2aa198>"</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>.latex</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>'"</span><span style=color:#268bd2> .</span><span> latex-mode)</span></span>
<span class=giallo-l><span>   (</span><span style=color:#2aa198>"</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>.bibtex</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>'"</span><span style=color:#268bd2> .</span><span> bibtex-mode))</span></span>
<span class=giallo-l><span>  :hook</span></span>
<span class=giallo-l><span>  ((LaTeX-mode </span><span style=color:#268bd2>.</span><span> LaTeX-math-mode)</span></span>
<span class=giallo-l><span>   (LaTeX-mode </span><span style=color:#268bd2>.</span><span> turn-on-reftex)</span></span>
<span class=giallo-l><span>   (LaTeX-mode </span><span style=color:#268bd2>.</span><span> TeX-fold-mode))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>   ...</span></span>
<span class=giallo-l><span>)</span></span></code></pre><p>See <a href=https://github.com/mor1/rc-emacs/blob/main/init.el#L739 rel=external>my <code>init.el</code></a> for <code>latex</code> package configuration details.<p>Finally finally, <code>typst</code>:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> typst-ts-mode</span></span>
<span class=giallo-l><span>  :after (eglot reformatter)</span></span>
<span class=giallo-l><span>  :mode</span><span style=color:#2aa198> "</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>.typ</span><span style=color:#cb4b16>\\</span><span style=color:#2aa198>'"</span></span>
<span class=giallo-l><span>  :preface</span></span>
<span class=giallo-l><span>  (reformatter-define </span><span style=color:#586e75;font-style:italic>;; XXX hack to autoformat on save as eglot-format doesn't work</span></span>
<span class=giallo-l><span>   typst-reformat</span></span>
<span class=giallo-l><span>   :program</span><span style=color:#2aa198> "typstyle"</span></span>
<span class=giallo-l><span>   :args</span><span style=color:#268bd2> `</span><span>(</span><span style=color:#2aa198>"--line-width" "120" "--indent-width" "2"</span><span>))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  :hook ((typst-ts-mode </span><span style=color:#268bd2>.</span><span> eglot-ensure) (typst-ts-mode </span><span style=color:#268bd2>.</span><span> typst-reformat-on-save-mode))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  :config</span></span>
<span class=giallo-l><span>  (add-to-list </span><span style=color:#268bd2>'</span><span>eglot-server-programs </span><span style=color:#268bd2>`</span><span>(typst-ts-mode </span><span style=color:#268bd2>.</span><span> (</span><span style=color:#2aa198>"tinymist" "lsp"</span><span>)))</span></span>
<span class=giallo-l><span>  (add-to-list </span><span style=color:#268bd2>'</span><span>filladapt-token-table </span><span style=color:#268bd2>'</span><span>(</span><span style=color:#2aa198>"/[ ][^:]+:"</span><span> bullet) </span><span style=color:#b58900>t</span><span>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  (</span><span style=color:#93a1a1;font-weight:700>defun</span><span style=color:#268bd2> typst-ts-tinymist-preview</span><span> ()</span></span>
<span class=giallo-l><span style=color:#2aa198>    "Run `tinymist preview` on the current file."</span></span>
<span class=giallo-l><span>    (interactive)</span></span>
<span class=giallo-l><span>    (</span><span style=color:#859900>let</span><span> ((file (buffer-file-name)))</span></span>
<span class=giallo-l><span>      (</span><span style=color:#859900>if</span><span> file</span></span>
<span class=giallo-l><span>          (</span><span style=color:#268bd2>compile</span><span> (</span><span style=color:#268bd2>format</span><span style=color:#2aa198> "tinymist preview %s"</span><span> (shell-quote-argument file)))</span></span>
<span class=giallo-l><span>        (user-error </span><span style=color:#2aa198>"Buffer is not visiting a file"</span><span>))))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  :bind (</span><span style=color:#2aa198>"C-c C-x"</span><span style=color:#268bd2> . #'</span><span>typst-ts-tinymist-preview)</span></span>
<span class=giallo-l><span>  :bind (:map typst-ts-mode-map (</span><span style=color:#2aa198>"C-c C-c"</span><span style=color:#268bd2> .</span><span> typst-ts-tmenu)))</span></span></code></pre><p>Both of the above have to set various other options as well as configuring Eglot.<p>But wait! There’s more! Specifically, for <a href=https://mort.io/blog/emacs-eglot/#simple-toml-and-bash>Bash</a>, <a href=https://mort.io/blog/emacs-eglot/#more-complex-python-latex-typst>LaTeX</a>, and <a href=https://mort.io/blog/emacs-eglot/#more-complex-python-latex-typst>Python</a>, I need to provide a default <em>workspace configuration</em> to set some sensible options.<h2 id=workspace-configuration><a aria-label="Anchor link for: workspace-configuration" class=zola-anchor href=#workspace-configuration>Workspace configuration</a></h2><p>This took me a little while to figure out. LSP servers assume a per-project “workspace”, apparently normally set from the project’s configuration file (either editor-independent but language-specific, or the Emacs specific but language-independent <code>.dir-locals.el</code>). As a now only occasional coder I prefer to set a global default and mostly rely on that.<p>However, the extra little fillip here is that you <strong>can’t</strong> set it locally in a buffer – and that includes via a major-mode hook (<a href=https://github.com/joaotavora/eglot/discussions/876 rel=external>discussed here</a>). I investigated using the <code>:initializationOptions</code> argument when setting <code>eglot-server-programs</code> so that I could keep all language-specific configuration together, but that appears to be supported by only some language servers :( So, for example, the <a href=https://mort.io/blog/emacs-eglot/#slightly-more-complex-nix>nixd</a> example uses it to configure use of <code>nixfmt</code> for formatting and it seems to work fine, but the equivalent for both Bash and Python did not.<p>So, I ended up just setting it in the Eglot configuration stanza using <code>setq-default</code>:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=common-lisp><span class=giallo-l><span>(</span><span style=color:#268bd2>use-package</span><span> eglot</span></span>
<span class=giallo-l><span>  :config</span></span>
<span class=giallo-l><span>  (setq-default</span></span>
<span class=giallo-l><span>   eglot-workspace-configuration</span></span>
<span class=giallo-l><span style=color:#268bd2>   '</span><span>(</span></span>
<span class=giallo-l><span style=color:#586e75;font-style:italic>     ;; sh/bash</span></span>
<span class=giallo-l><span>     :bashIde</span></span>
<span class=giallo-l><span>     (:backgroundAnalysisMaxFiles</span></span>
<span class=giallo-l><span style=color:#d33682>      0</span><span style=color:#586e75;font-style:italic> ;; turn off background analysis of directory tree</span></span>
<span class=giallo-l><span>      :shfmt (:binaryNextLine</span><span style=color:#b58900> t</span><span> :caseIndent</span><span style=color:#b58900> t</span><span> :simplifyCode</span><span style=color:#b58900> t</span><span> :spaceRedirects</span><span style=color:#b58900> t</span><span>))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#586e75;font-style:italic>     ;; ltex-ls-plus, giving grammar, spell checking for latex, markdown, etc</span></span>
<span class=giallo-l><span>     :ltex</span></span>
<span class=giallo-l><span>     (:language</span></span>
<span class=giallo-l><span style=color:#2aa198>      "en-GB"</span></span>
<span class=giallo-l><span>      :additionalRules (:enablePickyRules</span><span style=color:#b58900> t</span><span> :motherTongue</span><span style=color:#2aa198> "en-GB"</span><span>)</span></span>
<span class=giallo-l><span>      :completionEnabled</span><span style=color:#b58900> t</span><span>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#586e75;font-style:italic>     ;; python</span></span>
<span class=giallo-l><span>     :basedpyright (:disableOrganizeImports</span><span style=color:#b58900> t</span><span>)</span></span>
<span class=giallo-l><span>     :basedpyright.analysis</span></span>
<span class=giallo-l><span>     (:typeCheckingMode</span></span>
<span class=giallo-l><span style=color:#2aa198>      "all"</span></span>
<span class=giallo-l><span>      :autoImportCompletions</span><span style=color:#b58900> t</span></span>
<span class=giallo-l><span>      :inlayHints (:callArgumentNamesMatching</span><span style=color:#b58900> t</span><span>)</span></span>
<span class=giallo-l><span>      :useTypingExtensions</span><span style=color:#b58900> t</span><span>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#586e75;font-style:italic>     ;;</span></span>
<span class=giallo-l><span>     ))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  ...</span></span></code></pre><p>The final little nugget that I had to figure out to make the above work was what is the magic string that identifies the server so that it will process the correct configuration blob when it’s sent. Turns out this really is just a magic string and I needed to peruse docs and ultimately source to find it. So for example, for <code>bash-language-server</code> it turns out to be <code>bashIde</code>.<p>Possibly good general places to start looking are in the <code>*EGLOT*</code> logs from the server, your <code>*MESSAGES*</code> buffer, the server test for processing <code>onDidChangeConfigration</code> or (if one exists, and it probably does given the prevalence of LSPs in VSCode-land) in the <code>vscode-client</code> packaging, or some suitable declaration – in the case of <code>bash-language-server</code>, this turns out to be setting the variable <a href=https://github.com/bash-lsp/bash-language-server/blob/main/server/src/server.ts#L25 rel=external><code>CONFIGURATION_SECTION</code></a>.<p>Anyway. That mostly concludes my Emacs polishing. For now. Probably.<nav><div><a href=https://mort.io/blog/sabbatical-diary-w4/>‹ Sabbatical Diary: Week 4 / Month 1</a></div><div><a href=https://mort.io/blog/sabbatical-diary-w3/> Sabbatical Diary: Week 3 ›</a></div></nav></article></main><footer><hr><div class=c><nav class=tpad><div><a title="mort’s mythopœia Atom Feed" href=https://mort.io/atom.xml target=_blank type=application/atom+xml><i class="svg rss" title="mort’s mythopœia Atom Feed" type=Button></i></a><a title="mort’s mythopœia RSS Feed" href=https://mort.io/rss.xml target=_blank type=application/rss+xml><i class="svg rss" title="mort’s mythopœia RSS Feed" type=Button></i></a><a href=mailto:richard.mortier@cl.cam.ac.uk target=_blank title=Mail><i class="svg mail" title=Mail type=Button></i></a><a href=https://mastodon.me.uk/@mort rel=me target=_blank title=Mastodon><i class="svg mastodon" title=Mastodon type=Button></i></a><a href=https://www.linkedin.com/in/richard-mortier/ target=_blank title=LinkedIn><i class="svg linkedin" title=LinkedIn type=Button></i></a><a href=https://github.com/mor1/ target=_blank title=Github><i class="svg github" title=Github type=Button></i></a><a href=https://hub.docker.com/u/mor1/ target=_blank title=Docker><i class="svg docker" title=Docker type=Button></i></a><a href="https://www.youtube.com/playlist?list=PLkRF0fgqvvMx5Owh1QgilmExGQe58go_u" target=_blank title=YouTube><i class="svg youtube" title=YouTube type=Button></i></a></div></nav><nav class=vpad><a class=rpad href=https://mort.io/sitemap.xml target=_blank> sitemap </a><a class=rpad href=https://mort.io/tags/> tags </a></nav><p class=s90>mort’s mythopœia © 2013—<span id=year>2026</span> Richard Mortier</div></footer><span class=topout> <span class=topleft> </span><a title="Back to Top" class=top href=#><i class="svgs svgh angu"></i></a> </span>