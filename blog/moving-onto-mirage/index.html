<!doctype html><html lang=en><head><link href="https://mort.io/abridge.css?h=ef0df812e427238e124c" rel=stylesheet><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1" name=viewport><meta content=https://mort.io name=base><meta content=True name=HandheldFriendly><meta content=yes name=mobile-web-app-capable><meta content=yes name=apple-mobile-web-app-capable><meta content=default name=apple-mobile-web-app-status-bar-style><link title="mort’s mythopœia Atom Feed" href=https://mort.io/atom.xml rel=alternate type=application/atom+xml><link title="mort’s mythopœia RSS Feed" href=https://mort.io/rss.xml rel=alternate type=application/rss+xml><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>Moving Onto Mirage | mort’s mythopœia</title><meta content="mort’s mythopœia" name=copyright><meta content="Git Your Unikernel Here!" name=description><link href=https://mort.io/blog/moving-onto-mirage/ rel=canonical><meta content=https://mort.io/blog/moving-onto-mirage/ property=og:url><meta content=https://mort.io/blog/moving-onto-mirage/ name=twitter:url><meta content="Git Your Unikernel Here!" property=og:description><meta content="Git Your Unikernel Here!" name=twitter:description><meta content="Moving Onto Mirage | mort’s mythopœia" property=og:title><meta content="Moving Onto Mirage | mort’s mythopœia" name=twitter:title><meta content=summary name=twitter:card><meta content="mort’s mythopœia" property=og:site_name><meta content=en_US property=og:locale><meta content=website property=og:type><meta content=2015-05-20 property=og:updated_time><noscript><link href=https://mort.io/nojs.css rel=stylesheet></noscript><body><header><nav><div><big><a title="mort’s mythopœia" href=https://mort.io>mort’s mythopœia</a></big></div><div><div><ul><li><a class=s110 href=https://mort.io/research/> research </a><li><a class=s110 href=https://mort.io/students/> students </a><li><a class=s110 href=https://mort.io/teaching/> teaching </a><li><a class=s110 href=https://mort.io/codes/> codes </a><li><a class=s110 href=https://mort.io/me/> me </a></ul></div><div></div></div></nav><div class=desc>with apologies</div><hr></header><main><article><h1><a href=https://mort.io/blog/moving-onto-mirage/>Moving Onto Mirage</a></h1><span class=s95><span class=hpad> ·</span> 4 min read<span class=hpad> ·</span> May 20, 2015<span class=hpad> ·</span> #<a href=https://mort.io/tags/mirage/>mirage</a> #<a href=https://mort.io/tags/unikernels/>unikernels</a> #<a href=https://mort.io/tags/tech/>tech</a> </span><nav><div><a href=https://mort.io/blog/nexus-4-rescue/>‹ Rescuing a Shattered Nexus 4</a></div><div><a href=https://mort.io/blog/inconstant-ruby/> Diamonds are a Chap’s Best Friend ›</a></div></nav><p>For a little while I’ve had <a href=http://github.com/mor1/mor1.github.io>this site</a> running as a <a href=http://openmirage.org/>MirageOS</a> unikernel, shadowing the main site hosted on <a href=http://github.com/>GitHub</a>. I’ve finally decided to make the switch, as part of moving over to take advantage of Mirage’s DNS and TLS libraries.<p>Following the usual pattern, as previously explained by <a href=http://amirchaudhry.com/from-jekyll-to-unikernel-in-fifty-lines/>Amir</a>, <a href=http://www.somerandomidiot.com/blog/2014/08/19/i-am-unikernel/>Mindy</a> and others, the process is:<ul><li>Construct a static <a href=http://jekyllrb.com>Jekyll</a> site.<li>Write a <a href=http://travis-ci.com/>Travis</a> YAML file to cause <a href=http://travis-ci.com/>Travis</a> to build the unikernel image and commit it back to the deployment repository.<li>Write a Git <code>post-merge</code> hook for the deployment repository, so that the latest unikernel is automatically booted when a merge is detected, i.e., there is a new unikernel image.<li>Write a <code>cron</code> job that periodically polls the deployment repository, pulling any changes.</ul><p>Building a <a href=http://jekyllrb.com>Jekyll</a> site is well-documented – I did find that I had to tweak my <a href=https://github.com/mor1/mor1.github.io/blob/master/_config.yml><code>_config.yml</code></a> so as to make sure my local toolchain matched the one used by Github, ensuring consistency between versions of the site. For convenience:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span><span class="z-meta z-function-call z-arguments z-shell"> site</span>
</span></code></pre><h2 id=bringing-up-the-network><a aria-label="Anchor link for: bringing-up-the-network" class=zola-anchor href=#bringing-up-the-network>Bringing up the network</a></h2><p>The <a href=https://github.com/mor1/mor1.github.io/blob/master/.travis.yml><code>.travis.yml</code></a> file then specifies the three main targets for the CI test build to carry out: Unix with a standard sockets backed (<code>MIRAGE_BACKEND=unix</code>, <code>MIRAGE_NET=socket</code>) and with the Mirage network stack (<code>MIRAGE_BACKEND=unix</code>, <code>MIRAGE_NET=direct</code>), and with the Xen backend (<code>MIRAGE_BACKEND=xen</code>). For the latter case, we must also specify the static IP configuration to be used (<code>MIRAGE_ADDR</code>, <code>..._GWS</code>, and <code>..._MASK</code>). The <a href=https://github.com/mor1/mor1.github.io/blob/master/.travis.sh><code>.travis.sh</code></a> script then calls the standard skeleton <a href=https://github.com/ocaml/ocaml-travisci-skeleton/blob/master/.travis-mirage.sh><code>.travis-mirage.sh</code></a> script after first building the site content using Jekyll.<p>This tests the three basic combinations of network backend for a Mirage appliance:<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> make configure.socket build</span>
</span></code></pre><ul><li><strong>UNIX/socket</strong> requires no configuration. The network device is configured with the loopback address, <code>127.0.0.1</code>. Appliances can be run without requiring <code>root</code> privileges, assuming they only bind to non-privileged ports.</ul><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> make configure.direct build</span>
</span></code></pre><ul><li><strong>UNIX/direct/dhcp</strong> requires no configuration if a DHCP server is running and can respond. The appliance must be run with <code>root</code> privileges to use the new network bridging capability of OSX 10.10, whereupon the DHCP client in the appliance follows the usual protocol.</ul><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> make configure.xen build <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">  ADDR=<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>46.43.42.137<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> GWS=<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>46.43.42.129<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> MASK=<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>255.255.255.128<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span>
</span></code></pre><ul><li><strong>Xen</strong> uses the Mirage network stack and expects static configuration of the network device.</ul><h2 id=using-travis-ci><a aria-label="Anchor link for: using-travis-ci" class=zola-anchor href=#using-travis-ci>Using Travis CI</a></h2><p>Of course, all that is for local development – for the live site, this is actually all wrapped up using <a href=http://travis-ci.com/>Travis CI</a>. Due to a small pull request waiting on the <a href=https://github.com/ocaml/ocaml-travisci-skeleton>OCaml Travis CI skeleton scripts</a> and a few Mirage releases currently being readied, this looks a little more complex than it needs to (the <code>FORK_USER</code> and <code>DEV_REMOTE</code> variables shouldn’t need to be specified in the long run) but anyway:<pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">language</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">c</span>
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">script</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-unquoted z-plain z-out z-yaml">bash -ex .travis.sh</span>
</span><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">env</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">matrix</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">FORK_USER=mor1 DEV_REMOTE=git://github.com/mirage/mirage-dev</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml">OCAML_VERSION=4.02 MIRAGE_BACKEND=unix MIRAGE_NET=socket</span>
</span><span class="z-source z-yaml">  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">FORK_USER=mor1 DEV_REMOTE=git://github.com/mirage/mirage-dev</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml">OCAML_VERSION=4.02 MIRAGE_BACKEND=unix MIRAGE_NET=direct</span>
</span><span class="z-source z-yaml">  <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">FORK_USER=mor1 DEV_REMOTE=git://github.com/mirage/mirage-dev</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml">UPDATE_GCC_BINUTILS=1</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml">OCAML_VERSION=4.02 MIRAGE_BACKEND=xen</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml">MIRAGE_ADDR="46.43.42.137" MIRAGE_GWS="46.43.42.129" MIRAGE_MASK="255.255.255.128"</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml">XENIMG=mortio MIRDIR=_mirage DEPLOY=1</span>
</span></code></pre><p>This uses the local <a href=https://github.com/mor1/mor1.github.io/blob/master/.travis.sh><code>.travis-sh</code></a> script to build the three versions of the site, using the <a href=https://github.com/mirage/mirage-dev>Mirage development OPAM repository</a> so as to pick up the latest versions of all the various packages, and updating the Travis <code>gcc</code> and <code>binutils</code> to ensure the stubs for a couple of packages (notably <code>mirage-entropy-xen</code>) build.<p>Next stop: adding TLS and DNS support…<nav><div><a href=https://mort.io/blog/nexus-4-rescue/>‹ Rescuing a Shattered Nexus 4</a></div><div><a href=https://mort.io/blog/inconstant-ruby/> Diamonds are a Chap’s Best Friend ›</a></div></nav></article></main><footer><hr><div class=c><nav class=tpad><div><a title="mort’s mythopœia Atom Feed" href=https://mort.io/atom.xml target=_blank type=application/atom+xml><i class="svg rss" title="mort’s mythopœia Atom Feed" type=Button></i></a><a title="mort’s mythopœia RSS Feed" href=https://mort.io/rss.xml target=_blank type=application/rss+xml><i class="svg rss" title="mort’s mythopœia RSS Feed" type=Button></i></a><a href=mailto:richard.mortier@cl.cam.ac.uk target=_blank title=Mail><i class="svg mail" title=Mail type=Button></i></a><a href=https://mastodon.me.uk/@mort rel=me target=_blank title=Mastodon><i class="svg mastodon" title=Mastodon type=Button></i></a><a href=https://www.linkedin.com/in/richard-mortier/ target=_blank title=LinkedIn><i class="svg linkedin" title=LinkedIn type=Button></i></a><a href=https://github.com/mor1/ target=_blank title=Github><i class="svg github" title=Github type=Button></i></a><a href=https://hub.docker.com/u/mor1/ target=_blank title=Docker><i class="svg docker" title=Docker type=Button></i></a><a href="https://www.youtube.com/playlist?list=PLkRF0fgqvvMx5Owh1QgilmExGQe58go_u" target=_blank title=YouTube><i class="svg youtube" title=YouTube type=Button></i></a></div></nav><nav class=vpad><a class=rpad href=https://mort.io/sitemap.xml target=_blank> sitemap </a><a class=rpad href=https://mort.io/tags/> tags </a></nav><p class=s90>mort’s mythopœia © 2013—<span id=year>2025</span> Richard Mortier</div></footer><span class=topout> <span class=topleft> </span><a title="Back to Top" class=top href=#><i class="svgs svgh angu"></i></a> </span>