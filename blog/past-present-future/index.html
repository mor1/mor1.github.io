<!doctype html><html lang=en><head><link href="https://mort.io/abridge.css?h=5f1494977bbccc1fddc1" rel=stylesheet><meta charset=utf-8><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1" name=viewport><meta content=https://mort.io name=base><meta content=True name=HandheldFriendly><meta content=yes name=mobile-web-app-capable><meta content=yes name=apple-mobile-web-app-capable><meta content=default name=apple-mobile-web-app-status-bar-style><link title="mort’s mythopœia Atom Feed" href=https://mort.io/atom.xml rel=alternate type=application/atom+xml><link title="mort’s mythopœia RSS Feed" href=https://mort.io/rss.xml rel=alternate type=application/rss+xml><meta content="index, follow" name=robots><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=googlebot><meta content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" name=bingbot><title>Platforms, Packaging, Progress | mort’s mythopœia</title><meta content="mort’s mythopœia" name=copyright><meta content="Modernising a small OCaml package" name=description><link href=https://mort.io/blog/past-present-future/ rel=canonical><meta content=https://mort.io/blog/past-present-future/ property=og:url><meta content=https://mort.io/blog/past-present-future/ name=twitter:url><meta content="Modernising a small OCaml package" property=og:description><meta content="Modernising a small OCaml package" name=twitter:description><meta content="Platforms, Packaging, Progress | mort’s mythopœia" property=og:title><meta content="Platforms, Packaging, Progress | mort’s mythopœia" name=twitter:title><meta content=summary name=twitter:card><meta content="mort’s mythopœia" property=og:site_name><meta content=en_US property=og:locale><meta content=website property=og:type><meta content=2017-08-28 property=og:updated_time><noscript><link href=https://mort.io/nojs.css rel=stylesheet></noscript><body><header><nav><div><big><a title="mort’s mythopœia" href=https://mort.io>mort’s mythopœia</a></big></div><div><div><ul><li><a class=s110 href=https://mort.io/research/> research </a><li><a class=s110 href=https://mort.io/students/> students </a><li><a class=s110 href=https://mort.io/teaching/> teaching </a><li><a class=s110 href=https://mort.io/codes/> codes </a><li><a class=s110 href=https://mort.io/me/> me </a></ul></div><div></div></div></nav><div class=desc>with apologies</div><hr></header><main><article><h1><a href=https://mort.io/blog/past-present-future/>Platforms, Packaging, Progress</a></h1><span class=s95><span class=hpad> ·</span> 4 min read<span class=hpad> ·</span> August 28, 2017<span class=hpad> ·</span> #<a href=https://mort.io/tags/tech/>tech</a> #<a href=https://mort.io/tags/ocaml/>ocaml</a> #<a href=https://mort.io/tags/opam/>opam</a> #<a href=https://mort.io/tags/ocal/>ocal</a> </span><nav><div><a href=https://mort.io/blog/topkg-addendum/>‹ Platforms, Packaging, Progress— Addendum</a></div><div><a href=https://mort.io/blog/arming-linuxkit/> ARMing LinuxKit ›</a></div></nav><p>I recently decided to refresh and update my <a href=https://github.com/mor1/ocal/ rel=external>ocal</a> package,<sup class=footnote-reference id=fr-1-1><a href=#fn-1>1</a></sup> primarily to port it to use the excellent <a href=https://github.com/pqwy/notty/ rel=external>notty</a> before adding support for indicating week-of-year. At the same time, I took the opportunity to update the build infrastructure now that the OCaml world has some shiny new packaging and build tools to go with <a href=https://github.com/ocaml/opam/ rel=external>OPAM</a>, namely <a href=https://github.com/dbuenzli/topkg/ rel=external><code>topkg</code></a> and <a href=https://github.com/janestreet/jbuilder/ rel=external><code>jbuilder</code></a>. So, starting from <a href=http://github.com/djs55/ rel=external>Dave Scott’s</a> <a href=https://mirage.io/wiki/packaging rel=external>wiki entry</a> about how to package <a href=https://mirage.io/ rel=external>Mirage</a> libraries, here’s what I had to do…<h2 id=remove-oasis-remnants><a aria-label="Anchor link for: remove-oasis-remnants" class=zola-anchor href=#remove-oasis-remnants>Remove Oasis remnants</a></h2><pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=shellscript><span class=giallo-l><span style=color:#268bd2>git</span><span style=color:#2aa198> rm _oasis setup.ml Makefile</span><span style=color:#268bd2>*</span><span style=color:#2aa198> _tags myocamlbuild.ml .merlin</span></span>
<span class=giallo-l><span style=color:#268bd2>mv</span><span style=color:#2aa198> ocal.opam/opam o</span><span> &&</span><span style=color:#268bd2> git</span><span style=color:#2aa198> rm</span><span style=color:#cb4b16> -rf</span><span style=color:#2aa198> ocal.opam</span><span> &&</span><span style=color:#268bd2> mv</span><span style=color:#2aa198> o ocal.opam</span><span> &&</span><span style=color:#268bd2> git</span><span style=color:#2aa198> add ocal.opam</span></span>
<span class=giallo-l><span style=color:#268bd2>cat</span><span style=color:#859900> >|</span><span style=color:#268bd2> .gitignore</span><span style=color:#859900> &lt;&lt;</span><span>_EOF</span></span>
<span class=giallo-l><span style=color:#2aa198>_build</span></span>
<span class=giallo-l><span style=color:#2aa198>*.merlin</span></span>
<span class=giallo-l><span style=color:#2aa198>*.install</span></span>
<span class=giallo-l><span>_EOF</span></span></code></pre><p>Although we’re removing the <code>ocal.opam/descr</code> file, we’re not going to lose the content: we’re going to let <code>topkg opam pkg</code> use its default <code>--readme</code> option to extract the relevant info from the first marked up section of the <a href=https://github.com/mor1/ocal/blob/0.2.0/README.md rel=external><code>README.md</code></a>:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=markdown><span class=giallo-l><span style=color:#268bd2;font-weight:700># ocal — An improved Unix </span><span style=color:#2aa198>`cal`</span><span style=color:#268bd2;font-weight:700> utility</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>%%VERSION%%</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>A replacement for the standard Unix </span><span style=color:#2aa198>`cal`</span><span> utility. Partly because I could,</span></span>
<span class=giallo-l><span>partly because I'd become too irritated with its command line interface.</span></span></code></pre><p>We also remove but don’t lose the functionality of the <code>.merlin</code> and OPAM <code>ocal.install</code> files, as <a href=https://github.com/janestreet/jbuilder/ rel=external>jbuilder</a> will generate them for us.<h2 id=create-src-jbuild-file><a aria-label="Anchor link for: create-src-jbuild-file" class=zola-anchor href=#create-src-jbuild-file>Create <code>src/jbuild</code> file</a></h2><pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=shellscript><span class=giallo-l><span style=color:#268bd2>cat</span><span style=color:#859900> >|</span><span style=color:#268bd2> src/jbuild</span><span style=color:#859900> &lt;&lt;</span><span>_EOF</span></span>
<span class=giallo-l><span style=color:#2aa198>(jbuild_version 1)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#2aa198>(executable</span></span>
<span class=giallo-l><span style=color:#2aa198> ((public_name ocal)</span></span>
<span class=giallo-l><span style=color:#2aa198>  (package     ocal)</span></span>
<span class=giallo-l><span style=color:#2aa198>  (name        main)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#2aa198>  (libraries</span></span>
<span class=giallo-l><span style=color:#2aa198>   (</span></span>
<span class=giallo-l><span style=color:#2aa198>    astring</span></span>
<span class=giallo-l><span style=color:#2aa198>    calendar</span></span>
<span class=giallo-l><span style=color:#2aa198>    cmdliner</span></span>
<span class=giallo-l><span style=color:#2aa198>    notty</span></span>
<span class=giallo-l><span style=color:#2aa198>    notty.unix</span></span>
<span class=giallo-l><span style=color:#2aa198>    ))</span></span>
<span class=giallo-l><span style=color:#2aa198>  (flags (:standard -w "A-44-48-52" -safe-string))</span></span>
<span class=giallo-l><span style=color:#2aa198>  ))</span></span>
<span class=giallo-l><span>_EOF</span></span></code></pre><p>This corresponds to the <a href=https://github.com/mor1/ocal/releases/tag/0.2.0 rel=external>0.2.0</a> release of <a href=https://github.com/mor1/ocal/ rel=external>ocal</a>. Note that the <code>name</code> parameter refers to the module that contains the entrypoint for the executable, and that we turn on all warnings (<code>A</code>) except for three that we wish to ignore:<ul><li><code>44</code>: Open statement shadows an already defined identifier.<li><code>48</code>: Implicit elimination of optional arguments.<li><code>52</code>: (see 8.5.1) Fragile constant pattern.</ul><p>After I did some tidying up of the code to deal with the newly imposed warnings, <code>make</code> and <code>make install</code> satisfactorily (and quickly!) used <a href=https://github.com/janestreet/jbuilder/ rel=external>jbuilder</a> to build and install the executable as <code>~/.opam/system/bin/ocal</code> (thanks to the <code>public_name</code> stanza in the <code>src/jbuild</code> file, above). <code>make uninstall</code> then caused <a href=https://github.com/janestreet/jbuilder/ rel=external>jbuilder</a> to remove it, before I <code>opam</code> pinned it and then reinstall through <code>opam</code> to check that workflow worked as well:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=shellscript><span class=giallo-l><span style=color:#268bd2>opam</span><span style=color:#2aa198> remove ocal</span></span>
<span class=giallo-l><span style=color:#268bd2>opam</span><span style=color:#2aa198> pin add</span><span style=color:#cb4b16> -yn --dev-repo</span><span style=color:#2aa198> ocal .</span></span>
<span class=giallo-l><span style=color:#268bd2>opam</span><span style=color:#2aa198> install ocal</span></span></code></pre><h2 id=create-the-topkg-skeletons><a aria-label="Anchor link for: create-the-topkg-skeletons" class=zola-anchor href=#create-the-topkg-skeletons>Create the <code>topkg</code> skeletons</a></h2><p>Having refreshed the basic build infrastructure, next it’s time to update the packaging workflow. For a simple library we could use the automatic <a href=https://github.com/janestreet/jbuilder/ rel=external>jbuilder</a>/<a href=https://github.com/dbuenzli/topkg/ rel=external>topkg</a> plugin per the <a href=https://mirage.io/wiki/packaging rel=external>wiki entry</a>:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=shellscript><span class=giallo-l><span style=color:#268bd2>mkdir</span><span style=color:#2aa198> pkg</span></span>
<span class=giallo-l><span style=color:#268bd2>cat</span><span style=color:#859900> >|</span><span style=color:#268bd2> pkg/pkg.ml</span><span style=color:#859900> &lt;&lt;</span><span>_EOF</span></span>
<span class=giallo-l><span style=color:#2aa198>#!/usr/bin/env ocaml</span></span>
<span class=giallo-l><span style=color:#2aa198>#use "topfind"</span></span>
<span class=giallo-l><span style=color:#2aa198>#require "topkg-jbuilder.auto"</span></span>
<span class=giallo-l><span>_EOF</span></span></code></pre><p>However, this isn’t a library so we don’t have documentation to build so we don’t bother with the <code>odoc</code> skeleton. As a result we also need to customise <a href=https://github.com/mor1/ocal/blob/0.2.0/pkg/pkg.ml rel=external><code>pkg/pkg.ml</code></a> so as to stop <code>topkg publish</code> failing when it can’t build docs:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=ocaml><span class=giallo-l><span>#!/usr/bin/env ocaml</span></span>
<span class=giallo-l><span style=color:#586e75>#</span><span>use </span><span style=color:#2aa198>"topfind"</span></span>
<span class=giallo-l><span>#require </span><span style=color:#2aa198>"topkg-jbuilder"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#dc322f>open</span><span style=color:#d33682> Topkg</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#859900>let</span><span style=color:#268bd2> publish</span><span style=color:#859900> =</span></span>
<span class=giallo-l><span style=color:#d33682>  Pkg</span><span style=color:#859900>.</span><span>publish</span><span style=color:#dc322f> ~</span><span style=color:#b58900>artefacts</span><span style=color:#859900>:</span><span style=color:#93a1a1>[</span><span>`</span><span style=color:#93a1a1>Distrib] ()</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#859900>let</span><span style=color:#93a1a1> ()</span><span style=color:#859900> =</span></span>
<span class=giallo-l><span style=color:#d33682>  Topkg_jbuilder</span><span style=color:#859900>.</span><span>describe</span><span style=color:#dc322f> ~</span><span style=color:#b58900>publish</span><span style=color:#93a1a1> ()</span></span></code></pre><h2 id=prepare-a-release><a aria-label="Anchor link for: prepare-a-release" class=zola-anchor href=#prepare-a-release>Prepare a release</a></h2><p>Finally, we follow the standard <a href=https://github.com/dbuenzli/topkg/ rel=external>topkg</a> workflow to prepare a release. First, add an entry to <a href=https://github.com/mor1/ocal/blob/0.2.0/CHANGES.md rel=external><code>CHANGES.md</code></a> with the correct formatting and commit the result, and then:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=make><span class=giallo-l><span style=color:#268bd2>distrib</span><span>:</span></span>
<span class=giallo-l><span>	[ -x </span><span style=color:#268bd2>$$</span><span>(opam config var root)/plugins/opam-publish/repos/ocal ] || </span><span style=color:#cb4b16>\</span></span>
<span class=giallo-l><span>	  opam-publish repo add ocal mor1/ocal</span></span>
<span class=giallo-l><span>	topkg tag</span></span>
<span class=giallo-l><span>	topkg distrib</span></span></code></pre><p>…which creates tokens for accessing the GitHub repo for this project (if they don’t already exist), creates a release tag based on entries in <a href=https://github.com/mor1/ocal/blob/0.2.0/CHANGES.md rel=external><code>CHANGES.md</code></a>, and then creates the release tarballs (without the edits to <a href=https://github.com/mor1/ocal/blob/0.2.0/pkg/pkg.ml rel=external><code>pkg/pkg.ml</code></a> this would also build the docs, but we have none).<h2 id=publish-a-release><a aria-label="Anchor link for: publish-a-release" class=zola-anchor href=#publish-a-release>Publish a release</a></h2><p>Finally, we publish the release to GitHub and issue a pull request to the <a href=https://github.com/ocaml/opam/ rel=external>OPAM repository</a> to add the new release into OPAM after linting and tests have passed.<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=make><span class=giallo-l><span style=color:#268bd2>publish</span><span>:</span></span>
<span class=giallo-l><span>	topkg publish</span></span>
<span class=giallo-l><span>	topkg opam pkg</span></span>
<span class=giallo-l><span>	topkg opam submit</span></span></code></pre><p>Given that this repo has only a single package, we could in fact simply issue<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=plain><span class=giallo-l><span>topkg tag && topkg bistro</span></span></code></pre><p>Also, as an alternative to customising the <a href=https://github.com/mor1/ocal/blob/0.2.0/pkg/pkg.ml rel=external><code>pkg/pkg.ml</code></a> as indicated above, we could simply remember to indicate the appropriate customisation on the command line:<pre class=giallo style=color:#839496;background-color:#002b36><code data-lang=plain><span class=giallo-l><span>topkg publish distrib</span></span></code></pre><p>…but <code>topkg bistro</code> wouldn’t then work.<h2 id=conclusion><a aria-label="Anchor link for: conclusion" class=zola-anchor href=#conclusion>Conclusion</a></h2><p>So that’s it: a simple executable distribution taken from old-school <a href=http://oasis.forge.ocamlcore.org/ rel=external>Oasis</a> and <a href=https://ocaml.org/learn/tutorials/ocamlbuild/ rel=external>OCamlBuild</a> infrastructure to shiny new modern <a href=https://github.com/janestreet/jbuilder/ rel=external>jbuilder</a> and <a href=https://github.com/dbuenzli/topkg/ rel=external>topkg</a>. The new scheme seems to me to be an improvement: faster build times, simpler (to my eyes) metadata, autogeneration of more of the repeated metadata (<code>.merlin</code> etc), and a reasonably simple <a href=https://github.com/mor1/ocal/blob/0.2.0/Makefile rel=external><code>Makefile</code></a> that I actually think I understand. Definitely progress :)<section class=footnotes><ol class=footnotes-list><li id=fn-1><p>A somewhat over-featured replacement for the standard UNIX <code>cal</code> utility, because I got irritated by its American-centricity and my initial <a href=https://github.com/mor1/python-scripts/blob/master/cal.py rel=external>Python replacement</a> was just too slow… <a href=#fr-1-1>↩</a></p></ol></section><nav><div><a href=https://mort.io/blog/topkg-addendum/>‹ Platforms, Packaging, Progress— Addendum</a></div><div><a href=https://mort.io/blog/arming-linuxkit/> ARMing LinuxKit ›</a></div></nav></article></main><footer><hr><div class=c><nav class=tpad><div><a title="mort’s mythopœia Atom Feed" href=https://mort.io/atom.xml target=_blank type=application/atom+xml><i class="svg rss" title="mort’s mythopœia Atom Feed" type=Button></i></a><a title="mort’s mythopœia RSS Feed" href=https://mort.io/rss.xml target=_blank type=application/rss+xml><i class="svg rss" title="mort’s mythopœia RSS Feed" type=Button></i></a><a href=mailto:richard.mortier@cl.cam.ac.uk target=_blank title=Mail><i class="svg mail" title=Mail type=Button></i></a><a href=https://mastodon.me.uk/@mort rel=me target=_blank title=Mastodon><i class="svg mastodon" title=Mastodon type=Button></i></a><a href=https://www.linkedin.com/in/richard-mortier/ target=_blank title=LinkedIn><i class="svg linkedin" title=LinkedIn type=Button></i></a><a href=https://github.com/mor1/ target=_blank title=Github><i class="svg github" title=Github type=Button></i></a><a href=https://hub.docker.com/u/mor1/ target=_blank title=Docker><i class="svg docker" title=Docker type=Button></i></a><a href="https://www.youtube.com/playlist?list=PLkRF0fgqvvMx5Owh1QgilmExGQe58go_u" target=_blank title=YouTube><i class="svg youtube" title=YouTube type=Button></i></a></div></nav><nav class=vpad><a class=rpad href=https://mort.io/sitemap.xml target=_blank> sitemap </a><a class=rpad href=https://mort.io/tags/> tags </a></nav><p class=s90>mort’s mythopœia © 2013—<span id=year>2026</span> Richard Mortier</div></footer><span class=topout> <span class=topleft> </span><a title="Back to Top" class=top href=#><i class="svgs svgh angu"></i></a> </span>